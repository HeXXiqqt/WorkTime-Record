<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工时打卡系统 - 文艺复兴拟物风格</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        :root {
            --primary: #8B4513;
            --primary-light: #A0522D;
            --secondary: #CD853F;
            --success: #228B22;
            --info: #4682B4;
            --warning: #D2691E;
            --purple: #8A2BE2;
            --light: #F5DEB3;
            --dark: #5D4037;
            --gray: #8B7355;
            --border: #A0522D;
            --batch-selected: #F4A460;
            --batch-hover: #DEB887;
            --chart-bg: #FFF8DC;
            --gist-bg: #E6E6FA;
            --gist-border: #9370DB;
            
            --shadow-light: 0 2px 8px rgba(139, 69, 19, 0.2);
            --shadow-medium: 0 4px 16px rgba(139, 69, 19, 0.3);
            --shadow-heavy: 0 8px 24px rgba(139, 69, 19, 0.4);
        }
        
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f5deb3, #eedfcc);
            color: var(--dark);
            min-height: 100vh;
            padding: 15px 15px 100px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f5deb3"/><path d="M0 0L100 100M100 0L0 100" stroke="%23eedfcc" stroke-width="0.5"/></svg>');
        }
        
        .container { 
            max-width: 500px; 
            margin: auto; 
        }
        
        header {
            background: linear-gradient(145deg, #D2B48C, #F5DEB3);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--warning));
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .month-year {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--dark);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-family: 'Times New Roman', serif;
            letter-spacing: 1px;
        }
        
        .nav-buttons { 
            display: flex; 
            gap: 12px; 
        }
        
        .btn {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            color: #FFF8DC;
            border: 2px solid var(--dark);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: .95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-heavy);
        }
        
        .btn:hover::after {
            opacity: 1;
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: var(--shadow-light);
        }
        
        .btn i { 
            margin-right: 8px; 
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: inset 0 0 0 2px white;
        }
        
        .btn-outline:hover {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            color: #fff;
        }
        
        .btn-warning { 
            background: linear-gradient(145deg, var(--warning), #B22222);
        }
        
        .btn-warning:hover { 
            background: linear-gradient(145deg, #B22222, #8B0000); 
        }
        
        .btn-gist {
            background: linear-gradient(145deg, #24292e, #333333);
            color: white;
        }
        
        .btn-gist:hover {
            background: linear-gradient(145deg, #333333, #444444);
        }
        
        .btn-success {
            background: linear-gradient(145deg, #228B22, #32CD32);
        }
        
        .btn-success:hover {
            background: linear-gradient(145deg, #32CD32, #228B22);
        }
        
        .tabs { 
            display: flex; 
            background: linear-gradient(145deg, #DEB887, #F5DEB3);
            border-radius: 50px; 
            padding: 6px; 
            margin-top: 15px;
            border: 2px solid var(--primary);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark);
            font-family: 'Georgia', serif;
            text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .tab.active {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            color: #FFF8DC;
            box-shadow: var(--shadow-medium);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .calendar {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid var(--primary);
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #FFF8DC;
            font-weight: 700;
            text-align: center;
            padding: 15px 0;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 1px;
        }
        
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            padding: 12px;
            background: linear-gradient(145deg, #F5DEB3, #DEB887);
        }
        
        .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border-radius: 15px;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border);
            padding-top: 5px;
            overflow: hidden;
        }
        
        .day::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.3), transparent);
            border-radius: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .day:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }
        
        .day:hover::before {
            opacity: 1;
        }
        
        .day.other-month { 
            color: var(--gray); 
            opacity: .7;
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
        }
        
        .day.today {
            background: linear-gradient(145deg, #FFE4B5, #FFD700);
            color: var(--dark);
            font-weight: 700;
            border: 2px solid var(--warning);
            box-shadow: 0 0 0 3px rgba(210, 105, 30, 0.3);
        }
        
        .day.has-record {
            background: linear-gradient(145deg, #E0FFFF, #AFEEEE);
            border: 2px solid var(--info);
        }
        
        .day.batch-selected {
            background: linear-gradient(145deg, var(--batch-selected), #F5DEB3);
            box-shadow: inset 0 0 0 3px var(--primary);
        }
        
        .day.batch-selected:hover { 
            background: linear-gradient(145deg, var(--batch-hover), #F5DEB3); 
        }
        
        .day-record { 
            font-size: .65rem; 
            color: var(--success); 
            margin-top: 3px; 
            font-weight: 500; 
        }
        
        .day-holiday {
            font-size: .6rem;
            color: #8B0000;
            margin-top: 2px;
            background: linear-gradient(145deg, rgba(231, 76, 60, 0.2), rgba(231, 76, 60, 0.1));
            padding: 2px 5px;
            border-radius: 6px;
            line-height: 1.2;
            font-weight: 600;
        }
        
        .day-lunar {
            font-size: .6rem;
            color: var(--gray);
            margin-top: 2px;
            line-height: 1.2;
            font-style: italic;
        }
        
        .day-total {
            font-size: .65rem;
            font-weight: 600;
            color: var(--info);
            margin-top: 3px;
            background: linear-gradient(145deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.1));
            padding: 2px 5px;
            border-radius: 6px;
            line-height: 1.2;
        }
        
        .day-gregorian {
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 3px;
            text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.1);
        }
        
        .stats {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            padding: 25px;
            margin-bottom: 20px;
            border: 3px solid var(--primary);
            position: relative;
        }
        
        .stats::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--warning));
        }
        
        .stats h3 {
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-size: 1.4rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border-left: 5px solid var(--primary);
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            border-radius: 16px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stat-card:hover::after {
            opacity: 1;
        }
        
        .stat-card:nth-child(2) { border-left-color: var(--secondary); }
        .stat-card:nth-child(3) { border-left-color: var(--success); }
        .stat-card:nth-child(4) { border-left-color: var(--info); }
        .stat-card:nth-child(5) { border-left-color: var(--warning); }
        .stat-card:nth-child(6) { border-left-color: var(--purple); }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 8px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .stat-card .label {
            font-size: .9rem;
            color: var(--dark);
            font-weight: 600;
            font-family: 'Georgia', serif;
        }
        
        .chart-container {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-weight: 600;
            color: var(--dark);
            font-family: 'Georgia', serif;
            font-size: 1.2rem;
        }
        
        .chart-actions { 
            display: flex; 
            gap: 10px; 
        }
        
        .chart-btn {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            border: none;
            color: #FFF8DC;
            cursor: pointer;
            font-size: 0.95rem;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: var(--shadow-light);
            transition: all 0.3s;
        }
        
        .chart-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .chart-btn.active {
            background: linear-gradient(145deg, var(--secondary), var(--warning));
        }
        
        .chart-wrapper { 
            height: 280px; 
            position: relative; 
        }
        
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            padding: 20px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -6px 20px rgba(139, 69, 19, 0.5);
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
            z-index: 100;
            border-top: 3px solid var(--dark);
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #FFF8DC;
            font-size: .9rem;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .action-btn.active {
            color: #FFD700;
            transform: scale(1.1);
        }
        
        .action-btn i { 
            font-size: 1.6rem; 
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: .3s;
        }
        
        .modal.active { 
            opacity: 1; 
            pointer-events: all; 
        }
        
        .modal-content {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 25px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
            transform: translateY(20px);
            transition: .3s;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            border: 4px solid var(--primary);
        }
        
        .modal.active .modal-content { 
            transform: translateY(0); 
        }
        
        .modal-header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #FFF8DC;
            padding: 25px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .modal-body { 
            padding: 25px; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-family: 'Georgia', serif;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.05rem;
            transition: all 0.3s;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(139, 69, 19, 0.3);
        }
        
        .modal-footer { 
            display: flex; 
            padding: 0 25px 25px; 
            gap: 12px; 
        }
        
        .btn-block { 
            display: block; 
            width: 100%; 
            text-align: center; 
        }
        
        .tabs-inner { 
            display: flex; 
            border-bottom: 2px solid var(--border); 
            margin-bottom: 20px; 
        }
        
        .tab-inner {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            transition: .2s;
            color: var(--gray);
            font-weight: 600;
            font-family: 'Georgia', serif;
        }
        
        .tab-inner.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            font-weight: 700;
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        .shortcut-list { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            padding: 15px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border);
        }
        
        .shortcut-item:hover {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
            transform: translateX(8px);
            box-shadow: var(--shadow-medium);
        }
        
        .shortcut-item button { 
            background: transparent; 
            border: none; 
            color: red; 
            cursor: pointer; 
        }
        
        .year-table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border-radius: 18px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            border: 3px solid var(--primary);
        }
        
        .year-table th, .year-table td { 
            padding: 12px; 
            text-align: center; 
            border-bottom: 1px solid var(--border); 
        }
        
        .year-table th {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #FFF8DC;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .year-table tr:last-child td { 
            border-bottom: none; 
        }
        
        .year-table .btn-outline { 
            margin: 0 4px; 
        }
        
        .data-preview {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            padding: 25px;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 3px solid var(--primary);
        }
        
        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .data-actions { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
        }
        
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        .data-table thead th {
            background: linear-gradient(145deg, #DEB887, #F5DEB3);
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: #FFF8DC;
            border-bottom: 2px solid var(--primary);
        }
        
        .data-table tbody td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
        }
        
        .data-table tr:last-child td { 
            border-bottom: none; 
        }
        
        .data-table tr:hover td {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
        }
        
        .del-btn {
            background: linear-gradient(145deg, #B22222, #8B0000);
            color: white;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: var(--shadow-light);
        }
        
        .del-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-medium);
        }
        
        .batch-controls {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(145deg, #DEB887, #F5DEB3);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--primary);
            box-shadow: var(--shadow-medium);
        }
        
        .batch-info {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Georgia', serif;
        }
        
        .batch-actions { 
            display: flex; 
            gap: 10px; 
        }
        
        .chart-detail-content { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }
        
        .detail-item {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border);
        }
        
        .detail-item h4 {
            margin-bottom: 15px;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            font-family: 'Georgia', serif;
        }
        
        .detail-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
        }
        
        .detail-card {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-light);
            text-align: center;
            border-top: 4px solid var(--primary);
            border: 1px solid var(--border);
        }
        
        .detail-card:nth-child(2) { border-top-color: var(--secondary); }
        .detail-card:nth-child(3) { border-top-color: var(--success); }
        .detail-card:nth-child(4) { border-top-color: var(--info); }
        
        .detail-card .value { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: var(--primary);
        }
        
        .detail-card .label { 
            font-size: 0.9rem; 
            color: var(--dark); 
            margin-top: 8px; 
            font-weight: 600;
        }
        
        .exit-confirm-modal .modal-content { 
            max-width: 380px; 
        }
        
        .exit-confirm-modal .modal-body { 
            text-align: center; 
        }
        
        .exit-confirm-modal .modal-footer { 
            justify-content: center; 
        }
        
        .import-btn {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            color: var(--primary);
            border: 2px dashed var(--primary);
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-family: 'Georgia', serif;
            box-shadow: var(--shadow-light);
        }
        
        .import-btn:hover {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
            border-style: solid;
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }
        
        .import-btn input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .file-name {
            font-size: 15px;
            color: var(--dark);
            font-family: 'Georgia', serif;
        }
        
        .rainbow-text {
            background: linear-gradient(90deg, 
                var(--primary), var(--secondary), var(--warning));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            font-family: 'Georgia', serif;
        }
        
        .divider {
            height: 5px;
            background: linear-gradient(90deg, 
                var(--primary), var(--secondary), var(--warning));
            border-radius: 3px;
            margin: 20px 0;
        }
        
        .gist-sync {
            background: linear-gradient(145deg, var(--gist-bg), #D8BFD8);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 3px solid var(--gist-border);
            box-shadow: var(--shadow-heavy);
        }
        
        .gist-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: #24292e;
            font-family: 'Georgia', serif;
        }
        
        .gist-header i {
            font-size: 1.7rem;
        }
        
        .gist-status {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1rem;
            border-left: 5px solid var(--info);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border);
        }
        
        .gist-status.error {
            border-left-color: var(--warning);
        }
        
        .gist-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .token-input {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .token-input input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
        }
        
        .toast {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-family: 'Georgia', serif;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .gist-data-status {
            background: linear-gradient(145deg, #E8F5E9, #C8E6C9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            border-left: 4px solid #4caf50;
            border: 1px solid #4caf50;
        }
        
        .demo-mode {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, #228B22, #32CD32);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            font-family: 'Georgia', serif;
        }
        
        .info-display {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border);
        }
        
        .info-display h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-family: 'Georgia', serif;
        }
        
        .info-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .info-stat {
            text-align: center;
            padding: 15px;
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .info-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .info-stat .label {
            font-size: 0.9rem;
            color: var(--dark);
            margin-top: 5px;
        }
        
        .analysis-section {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border);
        }
        
        .analysis-section h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-family: 'Georgia', serif;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .analysis-card {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-light);
            text-align: center;
        }
        
        .analysis-card .title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .analysis-card .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* 新增：数据预览筛选和批量更改样式 */
        .data-filters {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid var(--border);
            box-shadow: var(--shadow-light);
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-btn {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--dark);
        }
        
        .filter-btn:hover {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .filter-btn.active {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            color: #FFF8DC;
            border-color: var(--dark);
        }
        
        .filter-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .filter-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
        }
        
        .batch-edit-controls {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid var(--border);
            box-shadow: var(--shadow-light);
            display: none;
        }
        
        .batch-edit-controls.active {
            display: block;
        }
        
        .batch-edit-controls h4 {
            margin-bottom: 10px;
            color: var(--dark);
            font-family: 'Georgia', serif;
        }
        
        .batch-edit-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .batch-edit-form .form-group {
            margin-bottom: 0;
        }
        
        .batch-edit-form input {
            padding: 8px;
            font-size: 0.9rem;
        }
        
        .batch-edit-form label {
            font-size: 0.85rem;
        }
        
        .batch-edit-summary {
            background: linear-gradient(145deg, #E8F5E9, #C8E6C9);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 10px;
            border-left: 4px solid #4caf50;
            border: 1px solid #4caf50;
        }
        
        .batch-edit-summary.error {
            background: linear-gradient(145deg, #FFEBEE, #FFCDD2);
            border-left-color: #f44336;
            border-color: #f44336;
        }
        
        .batch-edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .batch-edit-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 0.9rem;
        }
        
        .data-table tbody tr.hidden {
            display: none;
        }
        
        .data-table tbody tr.selected {
            background: linear-gradient(145deg, #FFF8DC, #F5DEB3) !important;
            border-left: 4px solid var(--primary);
        }
        
        .data-table tbody tr.selected td {
            background: transparent !important;
        }
        
        .data-table tbody tr:hover.selected {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA) !important;
        }
        
        .select-all-btn {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .select-all-btn:hover {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .select-all-btn.active {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            color: #FFF8DC;
            border-color: var(--dark);
        }
        
        /* 新增：批量更改选项 */
        .batch-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .batch-option {
            background: linear-gradient(145deg, #FFFFFF, #F5F5DC);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .batch-option:hover {
            background: linear-gradient(145deg, #F5F5DC, #EEE8AA);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .batch-option.active {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            color: #FFF8DC;
            border-color: var(--dark);
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            .header-content { 
                flex-direction: column; 
                gap: 15px; 
            }
            
            .nav-buttons { 
                width: 100%; 
                justify-content: center; 
            }
            
            .stats-grid { 
                grid-template-columns: 1fr; 
            }
            
            .data-actions { 
                flex-direction: column; 
            }
            
            .batch-controls { 
                flex-direction: column; 
                gap: 15px; 
            }
            
            .chart-wrapper { 
                height: 220px; 
            }
            
            .detail-grid { 
                grid-template-columns: 1fr; 
            }
            
            .gist-actions { 
                flex-direction: column; 
            }
            
            .token-input { 
                flex-direction: column; 
            }
            
            .modal-content {
                width: 95%;
            }
            
            .batch-edit-form {
                grid-template-columns: 1fr;
            }
            
            .filter-input-group {
                flex-direction: column;
            }
            
            .batch-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <header>
            <div class="header-content">
                <div class="month-year" id="monthYearText">2023年12月</div>
                <div class="nav-buttons">
                    <button class="btn" id="prevMonth"><i class="fas fa-chevron-left"></i> 上月</button>
                    <button class="btn" id="todayBtn">今日</button>
                    <button class="btn" id="nextMonth">下月 <i class="fas fa-chevron-right"></i></button>
                    <button class="btn" id="batchBtn"><i class="fas fa-calendar-check"></i> 批量打卡</button>
                </div>
            </div>
            <div class="tabs">
                <div class="tab active" data-view="month">月度视图</div>
                <div class="tab" data-view="year">年度视图</div>
                <div class="tab" data-view="data">数据预览</div>
                <div class="tab" data-view="stats">统计分析</div>
                <div class="tab" data-view="gist">云端同步</div>
            </div>
        </header>
        
        <div class="info-display">
            <h3><i class="fas fa-info-circle"></i> 本月概览</h3>
            <div class="info-stats">
                <div class="info-stat">
                    <div class="value" id="infoDays">0</div>
                    <div class="label">打卡天数</div>
                </div>
                <div class="info-stat">
                    <div class="value" id="infoHours">0</div>
                    <div class="label">总工时</div>
                </div>
                <div class="info-stat">
                    <div class="value" id="infoSalary">¥0</div>
                    <div class="label">预计收入</div>
                </div>
            </div>
        </div>
        
        <div id="batchControls" class="batch-controls" style="display:none;">
            <div class="batch-info"><i class="fas fa-calendar-check"></i> 已选择 <span id="selectedCount">0</span> 天</div>
            <div class="batch-actions">
                <button class="btn btn-outline" id="batchSelectAll"><i class="fas fa-check-square"></i> 全选</button>
                <button class="btn" id="batchApply"><i class="fas fa-play-circle"></i> 应用快捷打卡</button>
                <button class="btn btn-warning" id="batchCancel"><i class="fas fa-times"></i> 取消</button>
            </div>
        </div>
        
        <main>
            <div class="calendar" id="monthView">
                <div class="weekdays">
                    <div>周一</div><div>周二</div><div>周三</div><div>周四</div><div>周五</div><div>周六</div><div>周日</div>
                </div>
                <div class="days" id="calendarDays"></div>
            </div>
            
            <div class="data-preview" id="yearView" style="display:none;">
                <div class="data-header">
                    <h3><i class="fas fa-calendar-alt"></i> 年度打卡数据</h3>
                </div>
                <table class="year-table">
                    <thead>
                        <tr>
                            <th>月份</th><th>正班(小时)</th><th>平时加班(小时)</th>
                            <th>周末加班(小时)</th><th>收入(元)</th><th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="yearTableBody"></tbody>
                </table>
            </div>
            
            <div class="data-preview" id="dataView" style="display:none;">
                <div class="data-header">
                    <h3><i class="fas fa-table"></i> 打卡数据</h3>
                    <div class="data-actions">
                        <button class="btn btn-outline" id="exportCsv"><i class="fas fa-file-csv"></i> CSV</button>
                        <button class="btn btn-outline" id="exportJson"><i class="fas fa-file-code"></i> JSON</button>
                        <button class="btn btn-outline" id="importJson"><i class="fas fa-file-import"></i> 导入</button>
                        <button class="btn btn-outline" id="clearRecords" style="color:#B22222;border-color:#B22222;"><i class="fas fa-trash"></i> 清除全部</button>
                    </div>
                </div>
                
                <!-- 筛选和批量更改控制区 -->
                <div class="data-filters">
                    <div class="filter-group">
                        <button class="filter-btn" data-filter="all">全部</button>
                        <button class="filter-btn" data-filter="weekday">周一至周五</button>
                        <button class="filter-btn" data-filter="weekend">周六周日</button>
                        <button class="filter-btn" data-filter="hasData">有数据</button>
                        <button class="filter-btn" data-filter="noData">无数据</button>
                    </div>
                    <div class="filter-input-group">
                        <input type="text" id="dateFilter" placeholder="日期搜索 (如: 2023-12)">
                        <input type="number" id="hoursFilter" placeholder="工时 ≥ (小时)">
                    </div>
                    <div class="filter-group">
                        <button class="select-all-btn" id="selectAllFiltered">全选筛选结果</button>
                        <button class="filter-btn" id="clearSelection">清除选择</button>
                    </div>
                </div>
                
                <!-- 批量更改控制区 -->
                <div class="batch-edit-controls" id="batchEditControls">
                    <h4><i class="fas fa-edit"></i> 批量更改选中记录</h4>
                    
                    <!-- 批量更改选项 -->
                    <div class="batch-options">
                        <div class="batch-option" data-type="hours">只改工时</div>
                        <div class="batch-option" data-type="wages">只改时薪</div>
                        <div class="batch-option active" data-type="both">工时和时薪</div>
                    </div>
                    
                    <div class="batch-edit-form" id="batchEditForm">
                        <div class="form-group">
                            <label>正班工时 (小时)</label>
                            <input type="number" id="batchNormal" placeholder="0" value="8">
                        </div>
                        <div class="form-group">
                            <label>平时加班工时 (小时)</label>
                            <input type="number" id="batchOvertime" placeholder="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>周末加班工时 (小时)</label>
                            <input type="number" id="batchWeekend" placeholder="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>时薪 (元)</label>
                            <input type="number" id="batchWage" placeholder="80" value="80">
                        </div>
                        <div class="form-group">
                            <label>平时加班时薪 (元)</label>
                            <input type="number" id="batchOvertimeWage" placeholder="100" value="100">
                        </div>
                        <div class="form-group">
                            <label>周末加班时薪 (元)</label>
                            <input type="number" id="batchWeekendWage" placeholder="120" value="120">
                        </div>
                    </div>
                    <div class="batch-edit-summary" id="batchEditSummary"></div>
                    <div class="batch-edit-actions">
                        <button class="btn btn-outline" id="cancelBatchEdit">取消</button>
                        <button class="btn" id="confirmBatchEdit">确认更改</button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox"></th>
                            <th>日期</th><th>正班(小时)</th><th>平时加班(小时)</th>
                            <th>周末加班(小时)</th><th>时薪</th><th>平时加班时薪</th><th>周末加班时薪</th><th>日薪</th><th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </div>
            
            <div class="stats" id="statsView" style="display:none;">
                <h3><i class="fas fa-chart-bar"></i> 当月统计</h3>
                <div class="divider"></div>
                <div class="stats-grid" id="monthStatsGrid">
                    <div class="stat-card"><div class="value" id="monthDays">0</div><div class="label">打卡天数</div></div>
                    <div class="stat-card"><div class="value" id="monthNormal">0</div><div class="label">正班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthHours">0</div><div class="label">总工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthOvertime">0</div><div class="label">平时加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthWeekend">0</div><div class="label">周末加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="monthSalary">¥0</div><div class="label">月薪总额</div></div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">月度工时分布</div>
                        <div class="chart-actions">
                            <button class="chart-btn active" id="chartMonthHours"><i class="fas fa-chart-bar"></i> 工时</button>
                            <button class="chart-btn" id="chartMonthSalary"><i class="fas fa-yen-sign"></i> 薪资</button>
                        </div>
                    </div>
                    <div class="chart-wrapper"><canvas id="monthHoursChart"></canvas></div>
                </div>
                
                <div class="analysis-section">
                    <h3><i class="fas fa-search"></i> 数据分析</h3>
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <div class="title">平均每日工时</div>
                            <div class="value" id="avgDailyHours">0</div>
                        </div>
                        <div class="analysis-card">
                            <div class="title">加班频率</div>
                            <div class="value" id="overtimeFrequency">0%</div>
                        </div>
                        <div class="analysis-card">
                            <div class="title">周末加班天数</div>
                            <div class="value" id="weekendDays">0</div>
                        </div>
                        <div class="analysis-card">
                            <div class="title">最高单日收入</div>
                            <div class="value" id="maxDailyIncome">¥0</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top:30px;"><i class="fas fa-chart-line"></i> 当年统计</h3>
                <div class="divider"></div>
                <div class="stats-grid" id="yearStatsGrid">
                    <div class="stat-card"><div class="value" id="yearDays">0</div><div class="label">打卡天数</div></div>
                    <div class="stat-card"><div class="value" id="yearNormal">0</div><div class="label">正班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearHours">0</div><div class="label">总工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearOvertime">0</div><div class="label">平时加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearWeekend">0</div><div class="label">周末加班工时(小时)</div></div>
                    <div class="stat-card"><div class="value" id="yearSalary">¥0</div><div class="label">年薪总额</div></div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">年度工时趋势</div>
                        <div class="chart-actions">
                            <button class="chart-btn active" id="chartYearTrend"><i class="fas fa-chart-line"></i> 趋势</button>
                            <button class="chart-btn" id="chartYearCompare"><i class="fas fa-balance-scale"></i> 对比</button>
                        </div>
                    </div>
                    <div class="chart-wrapper"><canvas id="yearTrendChart"></canvas></div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">工时类型分布</div>
                        <div class="chart-actions">
                            <button class="chart-btn active" id="chartPieHours"><i class="fas fa-chart-pie"></i> 工时</button>
                            <button class="chart-btn" id="chartPieSalary"><i class="fas fa-money-bill-wave"></i> 薪资</button>
                        </div>
                    </div>
                    <div class="chart-wrapper"><canvas id="hoursPieChart"></canvas></div>
                </div>
            </div>
            
            <div class="gist-sync" id="gistView" style="display:none;">
                <div class="gist-header">
                    <i class="fab fa-github"></i>
                    <h3>GitHub Gist 同步</h3>
                </div>
                
                <div class="gist-status" id="gistStatus">
                    <i class="fas fa-info-circle"></i> 
                    <span>请设置GitHub个人访问令牌以启用云端同步功能</span>
                </div>
                
                <div class="token-input">
                    <input type="password" id="githubToken" placeholder="输入GitHub个人访问令牌">
                    <button class="btn btn-gist" id="saveToken"><i class="fas fa-key"></i> 保存</button>
                </div>
                
                <div class="gist-data-status" id="gistDataStatus" style="display:none;">
                    <i class="fas fa-cloud"></i>
                    <span>云端已存储历史数据，可直接恢复</span>
                </div>
                
                <div class="gist-actions">
                    <button class="btn btn-gist" id="pushToGist"><i class="fas fa-cloud-upload-alt"></i> 推送所有数据到云端</button>
                    <button class="btn btn-gist" id="pullFromGist"><i class="fas fa-cloud-download-alt"></i> 从云端拉取所有数据</button>
                    <button class="btn btn-success" id="recoverFromCloud"><i class="fas fa-history"></i> 只恢复打卡数据</button>
                    <button class="btn btn-outline" id="clearToken"><i class="fas fa-trash"></i> 清除Token</button>
                </div>
                
                <div class="form-group" style="margin-top:25px;">
                    <label>使用说明：</label>
                    <ol style="padding-left:25px; margin-top:12px; font-size:0.95rem;">
                        <li>登录GitHub，访问 <a href="https://github.com/settings/tokens" target="_blank">个人访问令牌页面</a></li>
                        <li>生成一个新Token（勾选gist权限）</li>
                        <li>将生成的Token粘贴到上方输入框并保存</li>
                        <li>使用"恢复云端数据"按钮获取历史记录</li>
                        <li>Token仅保存在本地浏览器中</li>
                    </ol>
                </div>
            </div>
        </main>
    </div>
    
    <div class="action-bar">
        <div class="action-btn active" id="tabCalendar"><i class="fas fa-calendar-alt"></i><span>打卡日历</span></div>
        <div class="action-btn" id="tabQuick"><i class="fas fa-plus-circle"></i><span>快捷打卡</span></div>
    </div>
    
    <div class="modal" id="punchModal">
        <div class="modal-content">
            <div class="modal-header"><span id="modalDate">2023年12月15日</span></div>
            <div class="modal-body">
                <div class="tabs-inner">
                    <div class="tab-inner active" data-tab="shortcuts">快捷</div>
                    <div class="tab-inner" data-tab="manual">手动</div>
                </div>
                <div class="tab-content active" id="shortcutsContent">
                    <div class="shortcut-list" id="shortcutList"></div>
                </div>
                <div class="tab-content" id="manualContent">
                    <div class="form-group"><label>正班工时 (小时)</label><input type="number" id="normalHours" placeholder="0" value="8"></div>
                    <div class="form-group"><label>平时加班工时 (小时)</label><input type="number" id="overtimeHours" placeholder="0" value="0"></div>
                    <div class="form-group"><label>周末加班工时 (小时)</label><input type="number" id="weekendHours" placeholder="0" value="0"></div>
                    <div class="form-group"><label>时薪 (元)</label><input type="number" id="hourlyWage" placeholder="80" value="80"></div>
                    <div class="form-group"><label>平时加班时薪 (元)</label><input type="number" id="overtimeWage" placeholder="100" value="100"></div>
                    <div class="form-group"><label>周末加班时薪 (元)</label><input type="number" id="weekendWage" placeholder="120" value="120"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelPunch">取消</button>
                <button class="btn" id="savePunch">保存</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="quickModal">
        <div class="modal-content">
            <div class="modal-header">添加快捷打卡</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>快捷名称</label>
                    <input type="text" id="quickName" placeholder="例如：标准工作日">
                </div>
                <div class="form-group">
                    <label>正班工时 (小时)</label>
                    <input type="number" id="quickNormal" value="8">
                </div>
                <div class="form-group">
                    <label>平时加班工时 (小时)</label>
                    <input type="number" id="quickOvertime" value="0">
                </div>
                <div class="form-group">
                    <label>周末加班工时 (小时)</label>
                    <input type="number" id="quickWeekend" value="0">
                </div>
                <div class="form-group">
                    <label>时薪 (元)</label>
                    <input type="number" id="quickWage" value="80">
                </div>
                <div class="form-group">
                    <label>平时加班时薪 (元)</label>
                    <input type="number" id="quickOvertimeWage" value="100">
                </div>
                <div class="form-group">
                    <label>周末加班时薪 (元)</label>
                    <input type="number" id="quickWeekendWage" value="120">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelQuick">取消</button>
                <button class="btn" id="saveQuick">保存</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="batchModal">
        <div class="modal-content">
            <div class="modal-header">批量应用快捷打卡</div>
            <div class="modal-body">
                <p>请选择要应用到已选日期的快捷打卡方案：</p>
                <div class="shortcut-list" id="batchShortcutList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBatch">取消</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">导入打卡数据</div>
            <div class="modal-body">
                <p>请选择要导入的文件（支持CSV和JSON格式）：</p>
                <div class="import-btn">
                    <i class="fas fa-file-import"></i> 选择文件
                    <input type="file" id="importFile" accept=".csv,.json">
                </div>
                <div class="file-info">
                    <span class="file-name" id="importFileName">未选择文件</span>
                </div>
                <div style="margin-top: 20px; background: linear-gradient(145deg, #FFE4E1, #FFB6C1); padding: 15px; border-radius: 10px; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-triangle"></i> 注意：导入数据将覆盖当前所有打卡记录
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelImport">取消</button>
                <button class="btn" id="confirmImport">确认导入</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="chartDetailModal">
        <div class="modal-content">
            <div class="modal-header">工时类型详情</div>
            <div class="modal-body">
                <div class="chart-detail-content">
                    <h4 id="detailType">正班工时</h4>
                    <div class="detail-grid">
                        <div class="detail-card">
                            <div class="value" id="detailHours">0</div>
                            <div class="label">总工时</div>
                        </div>
                        <div class="detail-card">
                            <div class="value" id="detailHoursPercent">0%</div>
                            <div class="label">工时占比</div>
                        </div>
                        <div class="detail-card">
                            <div class="value" id="detailSalary">¥0</div>
                            <div class="label">薪资总额</div>
                        </div>
                        <div class="detail-card">
                            <div class="value" id="detailSalaryPercent">0%</div>
                            <div class="label">薪资占比</div>
                        </div>
                        <div class="detail-card">
                            <div class="value" id="detailAvgHourly">¥0</div>
                            <div class="label">平均时薪</div>
                        </div>
                        <div class="detail-card">
                            <div class="value" id="detailDays">0</div>
                            <div class="label">打卡天数</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeChartDetail">关闭</button>
            </div>
        </div>
    </div>
    
    <div class="modal exit-confirm-modal" id="exitConfirmModal">
        <div class="modal-content">
            <div class="modal-header">确认离开</div>
            <div class="modal-body">
                <p>您确定要离开当前页面吗？所有未保存的数据将会丢失！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelExit">取消</button>
                <button class="btn" id="confirmExit">确定离开</button>
            </div>
        </div>
    </div>

    <script>
        /* 全局变量 */
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let selectedDate = new Date();
        let records = {};
        let shortcuts = [];
        let holidays = {
            '2023-10-01': '国庆节', '2023-10-02': '国庆节',
            '2023-10-03': '国庆节', '2023-12-25': '圣诞节'
        };
        let lunars = {
            '2023-10-01': '八月十七', '2023-10-02': '八月十八',
            '2023-10-03': '八月十九', '2023-12-25': '冬月十三'
        };
        let batchMode = false;
        let selectedDates = new Set();
        let githubToken = null;
        let gistId = null;
        let hasCloudData = false;
        
        // 数据预览筛选和批量更改相关
        let currentFilter = 'all';
        let selectedRows = new Set();
        let filterDate = '';
        let filterHours = 0;
        let batchEditType = 'both'; // 'hours', 'wages', 'both'
        
        // 图表实例
        let monthHoursChart = null;
        let yearTrendChart = null;
        let hoursPieChart = null;
        
        // 当前图表详情
        let chartDetail = { type: '', hours: 0, salary: 0, days: 0 };
        
        /* 本地存储键名 */
        const STORAGE_KEYS = {
            RECORDS: 'punchRecords',
            SHORTCUTS: 'punchShortcuts',
            GITHUB_TOKEN: 'githubToken',
            GIST_ID: 'gistId'
        };
        
        /* 初始化加载 */
        document.addEventListener('DOMContentLoaded', () => {
            setupExitConfirmation();
            loadAll();
            renderCalendar(currentYear, currentMonth);
            renderYearView();
            renderDataPreview();
            renderStats();
            renderShortcuts();
            setupEventListeners();
            updateGistStatus();
            updateInfoDisplay();
        });
        
        /* 显示提示 */
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        /* 设置退出确认 */
        function setupExitConfirmation() {
            window.addEventListener('beforeunload', function (e) {
                if (Object.keys(records).length > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                    openModal('exitConfirmModal');
                    return '您确定要离开当前页面吗？所有未保存的数据将会丢失！';
                }
            });
            
            window.addEventListener('popstate', function(e) {
                if (Object.keys(records).length > 0) {
                    e.preventDefault();
                    openModal('exitConfirmModal');
                }
            });
            
            document.getElementById('confirmExit').addEventListener('click', () => {
                window.removeEventListener('beforeunload', arguments.callee);
                window.location = 'about:blank';
            });
            
            document.getElementById('cancelExit').addEventListener('click', () => {
                closeModal('exitConfirmModal');
            });
        }
        
        /* 本地存储读取 */
        function loadAll() {
            const storedRecords = localStorage.getItem(STORAGE_KEYS.RECORDS);
            const storedShortcuts = localStorage.getItem(STORAGE_KEYS.SHORTCUTS);
            githubToken = localStorage.getItem(STORAGE_KEYS.GITHUB_TOKEN);
            gistId = localStorage.getItem(STORAGE_KEYS.GIST_ID);
            
            records = storedRecords ? JSON.parse(storedRecords) : {};
            shortcuts = storedShortcuts ? JSON.parse(storedShortcuts) : [
                { name: "标准工作日", normal: 8, overtime: 0, weekend: 0, wage: 80, overtimeWage: 100, weekendWage: 120 },
                { name: "加班2小时", normal: 8, overtime: 2, weekend: 0, wage: 80, overtimeWage: 100, weekendWage: 120 },
                { name: "周末加班", normal: 0, overtime: 0, weekend: 8, wage: 100, overtimeWage: 120, weekendWage: 120 }
            ];
            
            if (githubToken) {
                document.getElementById('githubToken').value = githubToken;
            }
        }
        
        /* 本地存储保存 */
        function saveAll() {
            localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(records));
            localStorage.setItem(STORAGE_KEYS.SHORTCUTS, JSON.stringify(shortcuts));
            if (githubToken) {
                localStorage.setItem(STORAGE_KEYS.GITHUB_TOKEN, githubToken);
            }
            if (gistId) {
                localStorage.setItem(STORAGE_KEYS.GIST_ID, gistId);
            }
        }
        
        /* 更新Gist状态显示 */
        function updateGistStatus(message = null, isError = false) {
            const statusEl = document.getElementById('gistStatus');
            const dataStatusEl = document.getElementById('gistDataStatus');
            
            if (message) {
                statusEl.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i> ${message}`;
                statusEl.className = isError ? 'gist-status error' : 'gist-status';
                return;
            }
            
            if (!githubToken) {
                statusEl.innerHTML = '<i class="fas fa-info-circle"></i> 请设置GitHub个人访问令牌以启用云端同步功能';
                statusEl.className = 'gist-status';
                dataStatusEl.style.display = 'none';
            } else if (hasCloudData) {
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i> 已设置Token，云端存在历史数据';
                statusEl.className = 'gist-status';
                dataStatusEl.style.display = 'block';
            } else {
                statusEl.innerHTML = '<i class="fas fa-info-circle"></i> 已设置Token，但云端无数据';
                statusEl.className = 'gist-status';
                dataStatusEl.style.display = 'none';
            }
        }
        
        /* 检查云端数据 */
        async function checkCloudData() {
            if (!githubToken) {
                updateGistStatus('请先设置GitHub Token', true);
                return false;
            }
            
            if (gistId) {
                hasCloudData = true;
                return true;
            }
            
            try {
                updateGistStatus('正在检查云端数据...');
                const response = await fetch('https://api.github.com/gists', {
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('获取Gist列表失败');
                }
                
                const gists = await response.json();
                const targetGist = gists.find(gist => 
                    gist.description === '工时打卡数据同步' && 
                    gist.files['punch-data.json']
                );
                
                if (targetGist) {
                    gistId = targetGist.id;
                    localStorage.setItem(STORAGE_KEYS.GIST_ID, gistId);
                    hasCloudData = true;
                    updateGistStatus();
                    return true;
                }
                
                hasCloudData = false;
                updateGistStatus('云端未找到历史数据');
                return false;
            } catch (error) {
                updateGistStatus(`检查失败: ${error.message}`, true);
                hasCloudData = false;
                return false;
            }
        }
        
        /* 格式化日期 */
        function formatDate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        /* 计算总工时 */
        function calculateTotalHours(rec) {
            return (rec.normal || 0) + (rec.overtime || 0) + (rec.weekend || 0);
        }
        
        /* 渲染月视图 */
        function renderCalendar(year, month) {
            document.getElementById('monthYearText').textContent = `${year}年${month+1}月`;
            const box = document.getElementById('calendarDays');
            box.innerHTML = '';
        
            const first = new Date(year, month, 1);
            const last = new Date(year, month+1, 0);
            
            let startDay = first.getDay();
            startDay = startDay === 0 ? 6 : startDay - 1;
            
            const prevLast = new Date(year, month, 0).getDate();
        
            for (let i = 0; i < startDay; i++) {
                const d = prevLast - (startDay - i - 1);
                const div = document.createElement('div');
                div.className = 'day other-month';
                
                const lunarDate = Lunar.fromDate(new Date(year, month - 1, d));
                const lunarStr = lunarDate.getDayInChinese();
                
                div.innerHTML = `<div class="day-gregorian">${d}</div><div class="day-lunar">${lunarStr}</div>`;
                box.appendChild(div);
            }
        
            const today = new Date();
            const todayStr = formatDate(today);
            
            for (let d = 1; d <= last.getDate(); d++) {
                const date = new Date(year, month, d);
                const str = formatDate(date);
                const rec = records[str];
        
                const div = document.createElement('div');
                div.className = 'day';
                if (str === todayStr) div.classList.add('today');
                if (rec) div.classList.add('has-record');
                
                if (batchMode && selectedDates.has(str)) {
                    div.classList.add('batch-selected');
                }
        
                const lunarDate = Lunar.fromDate(date);
                const lunarStr = lunarDate.getDayInChinese();
                
                let html = `<div class="day-gregorian">${d}</div><div class="day-lunar">${lunarStr}</div>`;
                
                if (holidays[str]) html += `<div class="day-holiday">${holidays[str]}</div>`;
                
                if (rec) {
                    const totalHours = calculateTotalHours(rec);
                    html += `<div class="day-total">${totalHours}小时</div>`;
                }
                
                div.innerHTML = html;
                
                div.addEventListener('click', () => {
                    if (batchMode) {
                        toggleDateSelection(str, div);
                    } else {
                        selectedDate = date;
                        openPunchModal(date, rec);
                    }
                });
                
                box.appendChild(div);
            }
        
            const totalCells = startDay + last.getDate();
            const remaining = 42 - totalCells;
            for (let i = 1; i <= remaining; i++) {
                const div = document.createElement('div');
                div.className = 'day other-month';
                
                const lunarDate = Lunar.fromDate(new Date(year, month + 1, i));
                const lunarStr = lunarDate.getDayInChinese();
                
                div.innerHTML = `<div class="day-gregorian">${i}</div><div class="day-lunar">${lunarStr}</div>`;
                box.appendChild(div);
            }
        }
        
        /* 切换日期选中状态 */
        function toggleDateSelection(dateStr, element) {
            if (selectedDates.has(dateStr)) {
                selectedDates.delete(dateStr);
                element.classList.remove('batch-selected');
            } else {
                selectedDates.add(dateStr);
                element.classList.add('batch-selected');
            }
            document.getElementById('selectedCount').textContent = selectedDates.size;
        }
        
        /* 进入批量模式 */
        function enterBatchMode() {
            batchMode = true;
            selectedDates.clear();
            document.getElementById('batchControls').style.display = 'flex';
            document.getElementById('batchBtn').textContent = '退出批量';
            document.getElementById('batchBtn').classList.add('btn-warning');
            document.getElementById('selectedCount').textContent = '0';
            renderCalendar(currentYear, currentMonth);
        }
        
        /* 退出批量模式 */
        function exitBatchMode() {
            batchMode = false;
            selectedDates.clear();
            document.getElementById('batchControls').style.display = 'none';
            document.getElementById('batchBtn').textContent = '批量打卡';
            document.getElementById('batchBtn').classList.remove('btn-warning');
            renderCalendar(currentYear, currentMonth);
        }
        
        /* 应用批量打卡 */
        function applyBatchPunch(shortcut) {
            selectedDates.forEach(dateStr => {
                records[dateStr] = {
                    normal: shortcut.normal,
                    overtime: shortcut.overtime,
                    weekend: shortcut.weekend,
                    hourlyWage: shortcut.wage,
                    overtimeWage: shortcut.overtimeWage,
                    weekendWage: shortcut.weekendWage
                };
            });
            saveAll();
            renderAll();
            exitBatchMode();
            closeModal('batchModal');
            showToast(`已成功为${selectedDates.size}天应用打卡数据`);
        }
        
        /* 渲染年视图 */
        function renderYearView() {
            const tbody = document.getElementById('yearTableBody');
            tbody.innerHTML = '';
            for (let m = 0; m < 12; m++) {
                const stats = getMonthStats(currentYear, m);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m+1}月</td>
                    <td>${stats.normalHours}</td>
                    <td>${stats.overtimeHours}</td>
                    <td>${stats.weekendHours}</td>
                    <td>¥${stats.salary}</td>
                    <td><button class="btn btn-outline" onclick="jumpToMonth(${m})">查看</button></td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        function jumpToMonth(month) {
            currentMonth = month;
            renderCalendar(currentYear, currentMonth);
            switchView('month');
        }
        
        /* 渲染数据预览 */
        function renderDataPreview() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            // 获取所有日期并排序
            const dates = Object.keys(records).sort((a, b) => b.localeCompare(a));
            
            dates.forEach(date => {
                const rec = records[date];
                const tr = document.createElement('tr');
                tr.dataset.date = date;
                tr.dataset.dayOfWeek = new Date(date).getDay();
                tr.dataset.hasData = 'true';
                tr.dataset.totalHours = calculateTotalHours(rec);
                
                const isSelected = selectedRows.has(date);
                if (isSelected) tr.classList.add('selected');
                
                tr.innerHTML = `
                    <td><input type="checkbox" class="row-select" data-date="${date}" ${isSelected ? 'checked' : ''}></td>
                    <td>${date}</td>
                    <td>${rec.normal || 0}</td>
                    <td>${rec.overtime || 0}</td>
                    <td>${rec.weekend || 0}</td>
                    <td>${rec.hourlyWage || 80}</td>
                    <td>${rec.overtimeWage || 100}</td>
                    <td>${rec.weekendWage || 120}</td>
                    <td>${calculateDaily(rec)}</td>
                    <td><button class="del-btn" data-date="${date}"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            
            // 绑定行选择事件
            tbody.querySelectorAll('.row-select').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const date = e.target.dataset.date;
                    const tr = e.target.closest('tr');
                    
                    if (e.target.checked) {
                        selectedRows.add(date);
                        tr.classList.add('selected');
                    } else {
                        selectedRows.delete(date);
                        tr.classList.remove('selected');
                    }
                    
                    updateBatchEditControls();
                });
            });
            
            // 绑定删除事件
            tbody.querySelectorAll('.del-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('确认删除该条记录？')) {
                        const date = btn.dataset.date;
                        delete records[date];
                        selectedRows.delete(date);
                        saveAll();
                        renderAll();
                    }
                });
            });
            
            // 更新批量更改控制区
            updateBatchEditControls();
        }
        
        /* 更新批量更改控制区 */
        function updateBatchEditControls() {
            const controls = document.getElementById('batchEditControls');
            const summary = document.getElementById('batchEditSummary');
            
            if (selectedRows.size > 0) {
                controls.classList.add('active');
                summary.className = 'batch-edit-summary';
                summary.innerHTML = `<strong>已选择 ${selectedRows.size} 条记录</strong>`;
            } else {
                controls.classList.remove('active');
                summary.innerHTML = '';
            }
        }
        
        /* 应用批量更改 */
        function applyBatchEdit() {
            const normal = parseFloat(document.getElementById('batchNormal').value) || 0;
            const overtime = parseFloat(document.getElementById('batchOvertime').value) || 0;
            const weekend = parseFloat(document.getElementById('batchWeekend').value) || 0;
            const wage = parseFloat(document.getElementById('batchWage').value) || 80;
            const overtimeWage = parseFloat(document.getElementById('batchOvertimeWage').value) || 100;
            const weekendWage = parseFloat(document.getElementById('batchWeekendWage').value) || 120;
            
            selectedRows.forEach(date => {
                const currentRec = records[date] || {};
                
                if (batchEditType === 'hours') {
                    // 只改工时
                    records[date] = {
                        normal: normal,
                        overtime: overtime,
                        weekend: weekend,
                        hourlyWage: currentRec.hourlyWage || 80,
                        overtimeWage: currentRec.overtimeWage || 100,
                        weekendWage: currentRec.weekendWage || 120
                    };
                } else if (batchEditType === 'wages') {
                    // 只改时薪
                    records[date] = {
                        normal: currentRec.normal || 0,
                        overtime: currentRec.overtime || 0,
                        weekend: currentRec.weekend || 0,
                        hourlyWage: wage,
                        overtimeWage: overtimeWage,
                        weekendWage: weekendWage
                    };
                } else {
                    // 工时和时薪都改
                    records[date] = {
                        normal: normal,
                        overtime: overtime,
                        weekend: weekend,
                        hourlyWage: wage,
                        overtimeWage: overtimeWage,
                        weekendWage: weekendWage
                    };
                }
            });
            
            saveAll();
            renderAll();
            showToast(`已成功更改${selectedRows.size}条记录`);
        }
        
        /* 应用筛选 */
        function applyFilter(filterType) {
            currentFilter = filterType;
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                const dayOfWeek = parseInt(row.dataset.dayOfWeek);
                const hasData = row.dataset.hasData === 'true';
                const totalHours = parseFloat(row.dataset.totalHours);
                const date = row.dataset.date;
                
                let show = true;
                
                switch(filterType) {
                    case 'all':
                        show = true;
                        break;
                    case 'weekday':
                        show = dayOfWeek >= 1 && dayOfWeek <= 5;
                        break;
                    case 'weekend':
                        show = dayOfWeek === 0 || dayOfWeek === 6;
                        break;
                    case 'hasData':
                        show = hasData;
                        break;
                    case 'noData':
                        show = !hasData;
                        break;
                }
                
                // 应用日期搜索
                if (filterDate && show) {
                    show = date.includes(filterDate);
                }
                
                // 应用工时筛选
                if (filterHours > 0 && show) {
                    show = totalHours >= filterHours;
                }
                
                if (show) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                    // 如果行被隐藏，取消选择
                    selectedRows.delete(date);
                    const checkbox = row.querySelector('.row-select');
                    if (checkbox) checkbox.checked = false;
                    row.classList.remove('selected');
                }
            });
            
            updateBatchEditControls();
        }
        
        /* 更新信息显示 */
        function updateInfoDisplay() {
            const m = getMonthStats(currentYear, currentMonth);
            document.getElementById('infoDays').textContent = m.days;
            document.getElementById('infoHours').textContent = m.normalHours + m.overtimeHours + m.weekendHours;
            document.getElementById('infoSalary').textContent = `¥${m.salary}`;
        }
        
        /* 渲染统计 */
        function renderStats() {
            const m = getMonthStats(currentYear, currentMonth);
            document.getElementById('monthDays').textContent = m.days;
            document.getElementById('monthNormal').textContent = m.normalHours;
            document.getElementById('monthHours').textContent = m.normalHours + m.overtimeHours + m.weekendHours;
            document.getElementById('monthOvertime').textContent = m.overtimeHours;
            document.getElementById('monthWeekend').textContent = m.weekendHours;
            document.getElementById('monthSalary').textContent = `¥${m.salary}`;
        
            const y = getYearStats(currentYear);
            document.getElementById('yearDays').textContent = y.days;
            document.getElementById('yearNormal').textContent = y.normalHours;
            document.getElementById('yearHours').textContent = y.normalHours + y.overtimeHours + y.weekendHours;
            document.getElementById('yearOvertime').textContent = y.overtimeHours;
            document.getElementById('yearWeekend').textContent = y.weekendHours;
            document.getElementById('yearSalary').textContent = `¥${y.salary}`;
            
            updateAnalysisData(m, y);
            
            renderMonthCharts();
            renderYearTrendChart();
            renderHoursPieChart();
        }
        
        /* 更新增强数据分析 */
        function updateAnalysisData(monthStats, yearStats) {
            const avgDaily = monthStats.days > 0 ? 
                ((monthStats.normalHours + monthStats.overtimeHours + monthStats.weekendHours) / monthStats.days).toFixed(1) : 0;
            document.getElementById('avgDailyHours').textContent = avgDaily;
            
            const overtimeFreq = monthStats.normalHours > 0 ? 
                ((monthStats.overtimeHours + monthStats.weekendHours) / 
                (monthStats.normalHours + monthStats.overtimeHours + monthStats.weekendHours) * 100).toFixed(1) : 0;
            document.getElementById('overtimeFrequency').textContent = `${overtimeFreq}%`;
            
            let weekendDays = 0;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const rec = records[formatDate(new Date(currentYear, currentMonth, d))];
                if (rec && (rec.weekend || 0) > 0) weekendDays++;
            }
            document.getElementById('weekendDays').textContent = weekendDays;
            
            let maxIncome = 0;
            Object.values(records).forEach(rec => {
                const income = calculateDaily(rec);
                if (income > maxIncome) maxIncome = income;
            });
            document.getElementById('maxDailyIncome').textContent = `¥${maxIncome}`;
        }
        
        /* 渲染月度图表 */
        function renderMonthCharts() {
            if (monthHoursChart) monthHoursChart.destroy();
            const ctx = document.getElementById('monthHoursChart').getContext('2d');
            const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
            const dayLabels = [];
            const normalHours = [];
            const overtimeHours = [];
            const weekendHours = [];
            const totalHours = [];
            
            for (let d = 1; d <= daysInMonth; d++) {
                dayLabels.push(`${d}日`);
                const date = new Date(currentYear, currentMonth, d);
                const str = formatDate(date);
                const rec = records[str] || {normal:0, overtime:0, weekend:0};
                
                normalHours.push(rec.normal || 0);
                overtimeHours.push(rec.overtime || 0);
                weekendHours.push(rec.weekend || 0);
                totalHours.push((rec.normal || 0) + (rec.overtime || 0) + (rec.weekend || 0));
            }
            
            monthHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: '正班工时', data: normalHours, backgroundColor: '#228B22', borderWidth: 0
                    }, {
                        label: '平时加班工时', data: overtimeHours, backgroundColor: '#FF8C00', borderWidth: 0
                    }, {
                        label: '周末加班工时', data: weekendHours, backgroundColor: '#D2691E', borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '工时 (小时)' } },
                        x: { title: { display: true, text: '日期' } }
                    },
                    plugins: {
                        title: { display: true, text: '每日工时分布' },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    const index = tooltipItems[0].dataIndex;
                                    return `总工时: ${totalHours[index]}小时`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /* 渲染年度趋势图 */
        function renderYearTrendChart() {
            if (yearTrendChart) yearTrendChart.destroy();
            const ctx = document.getElementById('yearTrendChart').getContext('2d');
            const monthLabels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const monthlyHours = [];
            const monthlySalary = [];
            
            for (let m = 0; m < 12; m++) {
                const stats = getMonthStats(currentYear, m);
                monthlyHours.push(stats.normalHours + stats.overtimeHours + stats.weekendHours);
                monthlySalary.push(stats.salary);
            }
            
            yearTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: '总工时', data: monthlyHours, borderColor: '#8B4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.1)', borderWidth: 3, fill: true,
                        tension: 0.3, yAxisID: 'y'
                    }, {
                        label: '月薪总额', data: monthlySalary, borderColor: '#228B22',
                        backgroundColor: 'rgba(34, 139, 34, 0.1)', borderWidth: 3, fill: true,
                        tension: 0.3, yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: '工时 (小时)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: '薪资 (元)' }, grid: { drawOnChartArea: false } }
                    },
                    plugins: {
                        title: { display: true, text: `${currentYear}年月度趋势` },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.datasetIndex === 0) label += context.parsed.y + '小时';
                                    else label += '¥' + context.parsed.y;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /* 渲染工时类型饼图 */
        function renderHoursPieChart() {
            if (hoursPieChart) hoursPieChart.destroy();
            const ctx = document.getElementById('hoursPieChart').getContext('2d');
            const stats = getYearStats(currentYear);
            const totalHours = stats.normalHours + stats.overtimeHours + stats.weekendHours;
            const normalPercent = totalHours > 0 ? (stats.normalHours / totalHours * 100) : 0;
            const overtimePercent = totalHours > 0 ? (stats.overtimeHours / totalHours * 100) : 0;
            const weekendPercent = totalHours > 0 ? (stats.weekendHours / totalHours * 100) : 0;
            
            const salaryByType = [0, 0, 0];
            Object.entries(records).forEach(([date, rec]) => {
                if (date.startsWith(currentYear)) {
                    salaryByType[0] += (rec.normal || 0) * (rec.hourlyWage || 80);
                    salaryByType[1] += (rec.overtime || 0) * (rec.overtimeWage || 100);
                    salaryByType[2] += (rec.weekend || 0) * (rec.weekendWage || 120);
                }
            });
            
            hoursPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['正班工时', '平时加班工时', '周末加班工时'],
                    datasets: [{
                        data: [stats.normalHours, stats.overtimeHours, stats.weekendHours],
                        backgroundColor: ['#228B22', '#FF8C00', '#D2691E'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '工时类型分布' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const percent = [normalPercent, overtimePercent, weekendPercent][context.dataIndex].toFixed(1);
                                    return `${label}: ${value}小时 (${percent}%)`;
                                }
                            }
                        },
                        legend: { position: 'bottom' }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const labels = ['正班工时', '平时加班工时', '周末加班工时'];
                            const hours = [stats.normalHours, stats.overtimeHours, stats.weekendHours];
                            const totalHours = stats.normalHours + stats.overtimeHours + stats.weekendHours;
                            const totalSalary = stats.salary;
                            
                            const hoursPercent = (hours[index] / totalHours * 100).toFixed(1);
                            const salaryPercent = (salaryByType[index] / totalSalary * 100).toFixed(1);
                            const avgHourly = hours[index] > 0 ? (salaryByType[index] / hours[index]).toFixed(2) : 0;
                            
                            let days = 0;
                            Object.entries(records).forEach(([date, rec]) => {
                                if (date.startsWith(currentYear)) {
                                    if (index === 0 && rec.normal > 0) days++;
                                    if (index === 1 && rec.overtime > 0) days++;
                                    if (index === 2 && rec.weekend > 0) days++;
                                }
                            });
                            
                            chartDetail = {
                                type: labels[index], hours: hours[index], salary: salaryByType[index],
                                days: days, hoursPercent: hoursPercent, salaryPercent: salaryPercent,
                                avgHourly: avgHourly
                            };
                            
                            showChartDetail();
                        }
                    }
                }
            });
        }
        
        /* 显示图表详情 */
        function showChartDetail() {
            document.getElementById('detailType').textContent = chartDetail.type;
            document.getElementById('detailHours').textContent = chartDetail.hours;
            document.getElementById('detailHoursPercent').textContent = chartDetail.hoursPercent + '%';
            document.getElementById('detailSalary').textContent = '¥' + chartDetail.salary.toFixed(2);
            document.getElementById('detailSalaryPercent').textContent = chartDetail.salaryPercent + '%';
            document.getElementById('detailAvgHourly').textContent = '¥' + chartDetail.avgHourly;
            document.getElementById('detailDays').textContent = chartDetail.days;
            
            openModal('chartDetailModal');
        }
        
        /* 渲染快捷列表 */
        function renderShortcuts() {
            const list = document.getElementById('shortcutList');
            list.innerHTML = '';
            if (shortcuts.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--gray);padding:25px;">暂无快捷，点击下方"添加"创建</div>';
                return;
            }
            shortcuts.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'shortcut-item';
                div.innerHTML = `
                    <div>
                        <strong>${s.name}</strong><br>
                        <small>正班:${s.normal}h 平时加班:${s.overtime}h 周末加班:${s.weekend}h 时薪:¥${s.wage} 平时加班时薪:¥${s.overtimeWage} 周末加班时薪:¥${s.weekendWage}</small>
                    </div>
                    <button class="del-shortcut" data-idx="${idx}"><i class="fas fa-times"></i></button>
                `;
                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.del-shortcut')) {
                        const str = formatDate(selectedDate);
                        records[str] = {
                            normal: s.normal, overtime: s.overtime,
                            weekend: s.weekend, hourlyWage: s.wage,
                            overtimeWage: s.overtimeWage, weekendWage: s.weekendWage
                        };
                        saveAll();
                        renderAll();
                        closeModal('punchModal');
                    }
                });
                list.appendChild(div);
            });
            list.querySelectorAll('.del-shortcut').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    shortcuts.splice(parseInt(btn.dataset.idx), 1);
                    saveAll();
                    renderShortcuts();
                });
            });
        }
        
        /* 渲染批量打卡快捷列表 */
        function renderBatchShortcuts() {
            const list = document.getElementById('batchShortcutList');
            list.innerHTML = '';
            if (shortcuts.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--gray);padding:25px;">暂无快捷，请先添加快捷打卡</div>';
                return;
            }
            shortcuts.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'shortcut-item';
                div.innerHTML = `
                    <div>
                        <strong>${s.name}</strong><br>
                        <small>正班:${s.normal}h 平时加班:${s.overtime}h 周末加班:${s.weekend}h 时薪:¥${s.wage} 平时加班时薪:¥${s.overtimeWage} 周末加班时薪:¥${s.weekendWage}</small>
                    </div>
                `;
                div.addEventListener('click', () => applyBatchPunch(s));
                list.appendChild(div);
            });
        }
        
        /* 获取统计 */
        function getMonthStats(year, month) {
            let days = 0, normal = 0, over = 0, week = 0, total = 0;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const rec = records[formatDate(new Date(year, month, d))];
                if (rec) {
                    days++;
                    normal += rec.normal || 0;
                    over += rec.overtime || 0;
                    week += rec.weekend || 0;
                    total += calculateDaily(rec);
                }
            }
            return { days, normalHours: normal, overtimeHours: over, weekendHours: week, salary: total };
        }
        
        function getYearStats(year) {
            let days = 0, normal = 0, over = 0, week = 0, total = 0;
            Object.entries(records).forEach(([date, rec]) => {
                if (date.startsWith(year)) {
                    days++;
                    normal += rec.normal || 0;
                    over += rec.overtime || 0;
                    week += rec.weekend || 0;
                    total += calculateDaily(rec);
                }
            });
            return { days, normalHours: normal, overtimeHours: over, weekendHours: week, salary: total };
        }
        
        /* 计算日薪 */
        function calculateDaily(rec) {
            const normalPay = (rec.normal || 0) * (rec.hourlyWage || 80);
            const overtimePay = (rec.overtime || 0) * (rec.overtimeWage || 100);
            const weekendPay = (rec.weekend || 0) * (rec.weekendWage || 120);
            return normalPay + overtimePay + weekendPay;
        }
        
        /* 统一刷新 */
        function renderAll() {
            renderCalendar(currentYear, currentMonth);
            renderYearView();
            renderDataPreview();
            renderStats();
            renderShortcuts();
            updateInfoDisplay();
        }
        
        /* 模态框 */
        function openPunchModal(date, rec) {
            selectedDate = new Date(date);
            document.getElementById('modalDate').textContent = `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日`;
            document.getElementById('normalHours').value = rec ? rec.normal || 0 : 8;
            document.getElementById('overtimeHours').value = rec ? rec.overtime || 0 : 0;
            document.getElementById('weekendHours').value = rec ? rec.weekend || 0 : 0;
            document.getElementById('hourlyWage').value = rec ? rec.hourlyWage || 80 : 80;
            document.getElementById('overtimeWage').value = rec ? rec.overtimeWage || 100 : 100;
            document.getElementById('weekendWage').value = rec ? rec.weekendWage || 120 : 120;
            openModal('punchModal');
        }
        
        function openModal(id) { 
            document.getElementById(id).classList.add('active'); 
            document.body.classList.add('modal-open');
        }
        
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            document.body.classList.remove('modal-open');
        }
        
        /* 视图切换 */
        function switchView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
            ['monthView', 'yearView', 'dataView', 'statsView', 'gistView'].forEach(id => {
                document.getElementById(id).style.display = id === view + 'View' ? 'block' : 'none';
            });
            if (view === 'data') renderDataPreview();
            if (view === 'stats') renderStats();
            if (view === 'year') renderYearView();
            if (view === 'gist') {
                updateGistStatus();
                if (githubToken) {
                    checkCloudData();
                }
            }
        }
        
        /* Gist 同步功能 */
        async function pushToGist() {
            if (!githubToken) {
                updateGistStatus('请先设置GitHub Token', true);
                return;
            }
            
            updateGistStatus('正在推送数据到云端...');
            
            const exportData = {
                records: Object.entries(records).map(([date, rec]) => ({
                    日期: date, 正班工时: rec.normal || 0, 平时加班工时: rec.overtime || 0,
                    周末加班工时: rec.weekend || 0, 时薪: rec.hourlyWage || 80,
                    平时加班时薪: rec.overtimeWage || 100, 周末加班时薪: rec.weekendWage || 120, 日薪: calculateDaily(rec)
                })),
                shortcuts: shortcuts
            };
            
            const content = JSON.stringify(exportData, null, 2);
            const fileName = 'punch-data.json';
            const description = '工时打卡数据同步';
            
            try {
                let response;
                if (gistId) {
                    response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description,
                            files: { [fileName]: { content } }
                        })
                    });
                } else {
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description,
                            public: false,
                            files: { [fileName]: { content } }
                        })
                    });
                }
                
                const result = await response.json();
                
                if (response.status >= 400) {
                    throw new Error(result.message || '推送数据失败');
                }
                
                if (!gistId) {
                    gistId = result.id;
                    localStorage.setItem(STORAGE_KEYS.GIST_ID, gistId);
                }
                
                hasCloudData = true;
                updateGistStatus('数据已成功推送到云端！');
                showToast('数据推送成功！');
            } catch (error) {
                console.error('推送失败:', error);
                updateGistStatus(`推送失败: ${error.message}`, true);
            }
        }
        
        async function pullFromGist() {
            if (!githubToken || !gistId) {
                updateGistStatus('请先设置Token并推送数据到云端', true);
                return;
            }
            
            updateGistStatus('正在从云端拉取数据...');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('拉取数据失败');
                }
                
                const gist = await response.json();
                const file = gist.files['punch-data.json'];
                if (!file) throw new Error('数据文件不存在');
                
                const importedData = JSON.parse(file.content);
                
                records = {};
                importedData.records.forEach(item => {
                    records[item['日期']] = {
                        normal: parseFloat(item['正班工时'] || 0),
                        overtime: parseFloat(item['平时加班工时'] || 0),
                        weekend: parseFloat(item['周末加班工时'] || 0),
                        hourlyWage: parseFloat(item['时薪'] || 80),
                        overtimeWage: parseFloat(item['平时加班时薪'] || 100),
                        weekendWage: parseFloat(item['周末加班时薪'] || 120)
                    };
                });
                
                const currentShortcuts = [...shortcuts];
                shortcuts = importedData.shortcuts || currentShortcuts;
                
                saveAll();
                renderAll();
                updateGistStatus('数据已成功从云端拉取并应用！');
                showToast('云端数据拉取成功！');
            } catch (error) {
                console.error('拉取失败:', error);
                updateGistStatus(`拉取失败: ${error.message}`, true);
            }
        }
        
        async function recoverFromCloud() {
            if (!githubToken) {
                updateGistStatus('请先设置GitHub Token', true);
                return;
            }
            
            const hasCloudData = await checkCloudData();
            if (!hasCloudData) {
                updateGistStatus('云端没有找到历史数据', true);
                return;
            }
            
            updateGistStatus('正在从云端恢复数据...');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('恢复数据失败');
                }
                
                const gist = await response.json();
                const file = gist.files['punch-data.json'];
                if (!file) throw new Error('数据文件不存在');
                
                const importedData = JSON.parse(file.content);
                
                records = {};
                importedData.records.forEach(item => {
                    records[item['日期']] = {
                        normal: parseFloat(item['正班工时'] || 0),
                        overtime: parseFloat(item['平时加班工时'] || 0),
                        weekend: parseFloat(item['周末加班工时'] || 0),
                        hourlyWage: parseFloat(item['时薪'] || 80),
                        overtimeWage: parseFloat(item['平时加班时薪'] || 100),
                        weekendWage: parseFloat(item['周末加班时薪'] || 120)
                    };
                });
                
                const currentShortcuts = [...shortcuts];
                shortcuts = importedData.shortcuts || currentShortcuts;
                
                saveAll();
                renderAll();
                updateGistStatus('数据已成功从云端恢复！');
                showToast('云端数据恢复成功！');
            } catch (error) {
                console.error('恢复失败:', error);
                updateGistStatus(`恢复失败: ${error.message}`, true);
            }
        }
        
        /* 事件绑定 */
        function setupEventListeners() {
            /* 顶部标签切换 */
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
        
            /* 月份翻页 */
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar(currentYear, currentMonth);
                updateInfoDisplay();
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar(currentYear, currentMonth);
                updateInfoDisplay();
            });
            
            document.getElementById('todayBtn').addEventListener('click', () => {
                currentDate = new Date();
                currentYear = currentDate.getFullYear();
                currentMonth = currentDate.getMonth();
                renderCalendar(currentYear, currentMonth);
                updateInfoDisplay();
            });
        
            /* 批量打卡功能 */
            document.getElementById('batchBtn').addEventListener('click', () => {
                batchMode ? exitBatchMode() : enterBatchMode();
            });
            
            document.getElementById('batchCancel').addEventListener('click', exitBatchMode);
            
            document.getElementById('batchSelectAll').addEventListener('click', () => {
                const days = document.querySelectorAll('.day:not(.other-month)');
                days.forEach(day => {
                    const dateText = day.querySelector('.day-gregorian').textContent;
                    const date = new Date(currentYear, currentMonth, parseInt(dateText));
                    const dateStr = formatDate(date);
                    
                    if (!day.classList.contains('other-month')) {
                        day.classList.add('batch-selected');
                        selectedDates.add(dateStr);
                    }
                });
                document.getElementById('selectedCount').textContent = selectedDates.size;
            });
            
            document.getElementById('batchApply').addEventListener('click', () => {
                if (selectedDates.size === 0) {
                    alert('请先选择要打卡的日期');
                    return;
                }
                renderBatchShortcuts();
                openModal('batchModal');
            });
            
            document.getElementById('cancelBatch').addEventListener('click', () => closeModal('batchModal'));
            
            /* 数据预览筛选和批量更改 */
            // 筛选按钮
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyFilter(btn.dataset.filter);
                });
            });
            
            // 日期搜索
            document.getElementById('dateFilter').addEventListener('input', (e) => {
                filterDate = e.target.value;
                applyFilter(currentFilter);
            });
            
            // 工时搜索
            document.getElementById('hoursFilter').addEventListener('input', (e) => {
                filterHours = parseFloat(e.target.value) || 0;
                applyFilter(currentFilter);
            });
            
            // 全选筛选结果
            document.getElementById('selectAllFiltered').addEventListener('click', () => {
                const visibleRows = document.querySelectorAll('#dataTableBody tr:not(.hidden)');
                visibleRows.forEach(row => {
                    const date = row.dataset.date;
                    const checkbox = row.querySelector('.row-select');
                    if (checkbox && !checkbox.checked) {
                        checkbox.checked = true;
                        selectedRows.add(date);
                        row.classList.add('selected');
                    }
                });
                updateBatchEditControls();
            });
            
            // 清除选择
            document.getElementById('clearSelection').addEventListener('click', () => {
                selectedRows.clear();
                document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
                document.querySelectorAll('#dataTableBody tr').forEach(row => row.classList.remove('selected'));
                updateBatchEditControls();
            });
            
            // 全选复选框
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.row-select:not(:disabled)');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    const date = cb.dataset.date;
                    const tr = cb.closest('tr');
                    
                    if (e.target.checked) {
                        selectedRows.add(date);
                        tr.classList.add('selected');
                    } else {
                        selectedRows.delete(date);
                        tr.classList.remove('selected');
                    }
                });
                updateBatchEditControls();
            });
            
            // 批量更改选项
            document.querySelectorAll('.batch-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.batch-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    batchEditType = option.dataset.type;
                    
                    // 根据选择显示/隐藏相关输入框
                    const form = document.getElementById('batchEditForm');
                    const inputs = form.querySelectorAll('input');
                    
                    if (batchEditType === 'hours') {
                        // 只改工时：显示前3个，隐藏后3个
                        inputs.forEach((input, index) => {
                            input.disabled = index >= 3;
                            input.parentElement.style.opacity = index >= 3 ? '0.5' : '1';
                        });
                    } else if (batchEditType === 'wages') {
                        // 只改时薪：隐藏前3个，显示后3个
                        inputs.forEach((input, index) => {
                            input.disabled = index < 3;
                            input.parentElement.style.opacity = index < 3 ? '0.5' : '1';
                        });
                    } else {
                        // 工时和时薪都改：全部显示
                        inputs.forEach(input => {
                            input.disabled = false;
                            input.parentElement.style.opacity = '1';
                        });
                    }
                    
                    updateBatchEditSummary();
                });
            });
            
            // 批量更改表单输入监听
            ['batchNormal', 'batchOvertime', 'batchWeekend', 'batchWage', 'batchOvertimeWage', 'batchWeekendWage'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateBatchEditSummary);
            });
            
            // 批量更改确认
            document.getElementById('confirmBatchEdit').addEventListener('click', applyBatchEdit);
            
            // 批量更改取消
            document.getElementById('cancelBatchEdit').addEventListener('click', () => {
                selectedRows.clear();
                document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
                document.querySelectorAll('#dataTableBody tr').forEach(row => row.classList.remove('selected'));
                updateBatchEditControls();
            });
            
            /* 模态框关闭 */
            document.getElementById('cancelPunch').addEventListener('click', () => closeModal('punchModal'));
            document.getElementById('cancelQuick').addEventListener('click', () => closeModal('quickModal'));
            document.getElementById('cancelImport').addEventListener('click', () => closeModal('importModal'));
            document.getElementById('closeChartDetail').addEventListener('click', () => closeModal('chartDetailModal'));
        
            /* 手动保存 */
            document.getElementById('savePunch').addEventListener('click', () => {
                const str = formatDate(selectedDate);
                const n = parseFloat(document.getElementById('normalHours').value) || 0;
                const o = parseFloat(document.getElementById('overtimeHours').value) || 0;
                const w = parseFloat(document.getElementById('weekendHours').value) || 0;
                const h = parseFloat(document.getElementById('hourlyWage').value) || 80;
                const ow = parseFloat(document.getElementById('overtimeWage').value) || 100;
                const ww = parseFloat(document.getElementById('weekendWage').value) || 120;
                records[str] = { normal: n, overtime: o, weekend: w, hourlyWage: h, overtimeWage: ow, weekendWage: ww };
                saveAll();
                renderAll();
                closeModal('punchModal');
            });
        
            /* 添加快捷 */
            document.getElementById('tabQuick').addEventListener('click', () => openModal('quickModal'));
            
            document.getElementById('saveQuick').addEventListener('click', () => {
                const name = document.getElementById('quickName').value.trim();
                if (!name) { alert('请输入名称'); return; }
                shortcuts.push({
                    name,
                    normal: parseFloat(document.getElementById('quickNormal').value) || 0,
                    overtime: parseFloat(document.getElementById('quickOvertime').value) || 0,
                    weekend: parseFloat(document.getElementById('quickWeekend').value) || 0,
                    wage: parseFloat(document.getElementById('quickWage').value) || 80,
                    overtimeWage: parseFloat(document.getElementById('quickOvertimeWage').value) || 100,
                    weekendWage: parseFloat(document.getElementById('quickWeekendWage').value) || 120
                });
                saveAll();
                renderShortcuts();
                closeModal('quickModal');
                document.getElementById('quickName').value = '';
                document.getElementById('quickNormal').value = 8;
                document.getElementById('quickOvertime').value = 0;
                document.getElementById('quickWeekend').value = 0;
                document.getElementById('quickWage').value = 80;
                document.getElementById('quickOvertimeWage').value = 100;
                document.getElementById('quickWeekendWage').value = 120;
            });
        
            /* 模态框内部标签切换 */
            document.querySelectorAll('.tab-inner').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab-inner').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Content').classList.add('active');
                });
            });
        
            /* 导出/导入/清除 */
            document.getElementById('exportCsv').addEventListener('click', () => exportFile('csv'));
            document.getElementById('exportJson').addEventListener('click', () => exportFile('json'));
            document.getElementById('importJson').addEventListener('click', () => openModal('importModal'));
            
            document.getElementById('clearRecords').addEventListener('click', () => {
                if (confirm('确认清除全部记录？不可恢复！')) {
                    records = {};
                    selectedRows.clear();
                    saveAll();
                    renderAll();
                }
            });
            
            document.getElementById('importFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                document.getElementById('importFileName').textContent = file ? file.name : '未选择文件';
            });
            
            document.getElementById('confirmImport').addEventListener('click', () => {
                const file = document.getElementById('importFile').files[0];
                if (!file) {
                    alert('请先选择要导入的文件');
                    return;
                }
                
                const fileName = file.name.toLowerCase();
                const isCSV = fileName.endsWith('.csv');
                const isJSON = fileName.endsWith('.json');
                
                if (!isCSV && !isJSON) {
                    alert('请选择CSV或JSON格式的文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (isCSV) {
                            // 处理CSV文件
                            Papa.parse(e.target.result, {
                                header: true,
                                complete: function(results) {
                                    const newRecords = {};
                                    results.data.forEach(item => {
                                        if (item['日期']) {
                                            newRecords[item['日期']] = {
                                                normal: parseFloat(item['正班工时'] || 0),
                                                overtime: parseFloat(item['平时加班工时'] || 0),
                                                weekend: parseFloat(item['周末加班工时'] || 0),
                                                hourlyWage: parseFloat(item['时薪'] || 80),
                                                overtimeWage: parseFloat(item['平时加班时薪'] || 100),
                                                weekendWage: parseFloat(item['周末加班时薪'] || 120)
                                            };
                                        }
                                    });
                                    records = newRecords;
                                    selectedRows.clear();
                                    saveAll();
                                    renderAll();
                                    closeModal('importModal');
                                    alert('CSV导入成功！');
                                },
                                error: function(error) {
                                    console.error('CSV解析错误:', error);
                                    alert('CSV文件解析失败，请检查格式');
                                }
                            });
                        } else {
                            // 处理JSON文件
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.records && importedData.shortcuts) {
                                const newRecords = {};
                                importedData.records.forEach(item => {
                                    newRecords[item['日期']] = {
                                        normal: parseFloat(item['正班工时'] || 0),
                                        overtime: parseFloat(item['平时加班工时'] || 0),
                                        weekend: parseFloat(item['周末加班工时'] || 0),
                                        hourlyWage: parseFloat(item['时薪'] || 80),
                                        overtimeWage: parseFloat(item['平时加班时薪'] || 100),
                                        weekendWage: parseFloat(item['周末加班时薪'] || 120)
                                    };
                                });
                                records = newRecords;
                                shortcuts = importedData.shortcuts;
                                selectedRows.clear();
                                saveAll();
                                renderAll();
                                closeModal('importModal');
                                alert('JSON导入成功！');
                            } else if (Array.isArray(importedData)) {
                                const newRecords = {};
                                importedData.forEach(item => {
                                    newRecords[item['日期']] = {
                                        normal: parseFloat(item['正班工时'] || 0),
                                        overtime: parseFloat(item['平时加班工时'] || 0),
                                        weekend: parseFloat(item['周末加班工时'] || 0),
                                        hourlyWage: parseFloat(item['时薪'] || 80),
                                        overtimeWage: parseFloat(item['平时加班时薪'] || 100),
                                        weekendWage: parseFloat(item['周末加班时薪'] || 120)
                                    };
                                });
                                records = newRecords;
                                selectedRows.clear();
                                saveAll();
                                renderAll();
                                closeModal('importModal');
                                alert('JSON导入成功（旧格式）！');
                            } else {
                                throw new Error('文件格式不正确');
                            }
                        }
                    } catch (error) {
                        console.error('解析错误:', error);
                        alert('文件解析失败，请检查格式是否正确');
                    }
                };
                reader.readAsText(file);
            });
        
            /* Gist 同步功能 */
            document.getElementById('saveToken').addEventListener('click', () => {
                githubToken = document.getElementById('githubToken').value.trim();
                if (!githubToken) {
                    updateGistStatus('请输入有效的Token', true);
                    return;
                }
                localStorage.setItem(STORAGE_KEYS.GITHUB_TOKEN, githubToken);
                updateGistStatus('Token已保存成功！');
                checkCloudData();
            });
            
            document.getElementById('pushToGist').addEventListener('click', pushToGist);
            document.getElementById('pullFromGist').addEventListener('click', pullFromGist);
            document.getElementById('recoverFromCloud').addEventListener('click', recoverFromCloud);
            
            document.getElementById('clearToken').addEventListener('click', () => {
                if (confirm('确认清除Token？这将断开与云端的连接')) {
                    githubToken = null;
                    gistId = null;
                    localStorage.removeItem(STORAGE_KEYS.GITHUB_TOKEN);
                    localStorage.removeItem(STORAGE_KEYS.GIST_ID);
                    document.getElementById('githubToken').value = '';
                    updateGistStatus();
                }
            });
        
            /* 底部按钮 */
            document.getElementById('tabCalendar').addEventListener('click', () => {
                document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tabCalendar').classList.add('active');
                switchView('month');
            });
            
            document.getElementById('tabQuick').addEventListener('click', () => {
                document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tabQuick').classList.add('active');
                const now = new Date();
                selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                openModal('quickModal');
            });
        }
        
        /* 更新批量更改摘要 */
        function updateBatchEditSummary() {
            const normal = parseFloat(document.getElementById('batchNormal').value) || 0;
            const overtime = parseFloat(document.getElementById('batchOvertime').value) || 0;
            const weekend = parseFloat(document.getElementById('batchWeekend').value) || 0;
            const wage = parseFloat(document.getElementById('batchWage').value) || 80;
            const overtimeWage = parseFloat(document.getElementById('batchOvertimeWage').value) || 100;
            const weekendWage = parseFloat(document.getElementById('batchWeekendWage').value) || 120;
            
            let summaryText = '';
            
            if (batchEditType === 'hours') {
                summaryText = `<strong>将更改工时：</strong><br>正班: ${normal}h, 平时加班: ${overtime}h, 周末加班: ${weekend}h`;
            } else if (batchEditType === 'wages') {
                summaryText = `<strong>将更改时薪：</strong><br>时薪: ¥${wage}, 平时加班时薪: ¥${overtimeWage}, 周末加班时薪: ¥${weekendWage}`;
            } else {
                summaryText = `<strong>将更改工时和时薪：</strong><br>正班: ${normal}h, 平时加班: ${overtime}h, 周末加班: ${weekend}h<br>时薪: ¥${wage}, 平时加班时薪: ¥${overtimeWage}, 周末加班时薪: ¥${weekendWage}`;
            }
            
            const summaryEl = document.getElementById('batchEditSummary');
            summaryEl.className = 'batch-edit-summary';
            summaryEl.innerHTML = summaryText;
        }
        
        /* 导出文件 */
        function exportFile(type) {
            const data = Object.entries(records).map(([date, rec]) => ({
                日期: date, 正班工时: rec.normal || 0, 平时加班工时: rec.overtime || 0,
                周末加班工时: rec.weekend || 0, 时薪: rec.hourlyWage || 80,
                平时加班时薪: rec.overtimeWage || 100, 周末加班时薪: rec.weekendWage || 120, 日薪: calculateDaily(rec)
            }));
            
            if (type === 'csv') {
                const csv = Papa.unparse(data, { header: true });
                downloadBlob('\ufeff' + csv, '工时打卡.csv', 'text/csv;charset=utf-8;');
            } else {
                const exportData = { records: data, shortcuts: shortcuts };
                downloadBlob(JSON.stringify(exportData, null, 2), '工时打卡.json', 'application/json;charset=utf-8;');
            }
        }
        
        function downloadBlob(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>